import numpy as np
import struct

####################################################""

def circle_init(y, Kp, R_init):
   ths = np.linspace(0, 2 * np.pi, Kp)
   x0 = y.mean(axis=0)
   return x0 + R_init * np.array([np.cos(ths), np.sin(ths)]).T

####################################################""

dump_file = open("test_som.out", "wb")
dump_level = 0

def dump_scalar(level, v, name):
   global dump_level
   if level <= dump_level:
      buf = bytearray()
      buf += struct.pack("i", len(name))
      buf += name.encode('ascii')
      buf += struct.pack("i", 1)
      buf += struct.pack("i", 1)
      buf += struct.pack("d", v)
      dump_file.write(buf)
   

def dump_array(m, name):
   buf = bytearray()
   rows = m.shape[0]
   buf += struct.pack("i", len(name))
   buf += name.encode('ascii')
   buf += struct.pack("i", rows)
   buf += struct.pack("i", 1)
   for i in range(0, rows):
      buf += struct.pack("d", m[i])
   dump_file.write(buf)
   
def dump_matrix(m, name):
   buf = bytearray()
   rows = m.shape[0]
   cols = m.shape[1]
   buf += struct.pack("i", len(name))
   buf += name.encode('ascii')
   buf += struct.pack("i", rows)
   buf += struct.pack("i", cols)
   for i in range(0, rows):
      for j in range(0, cols):
         buf += struct.pack("d", m[i][j])
   dump_file.write(buf)

def dump(level, m, name):
   global dump_level
   if level <= dump_level:
      axes = len(m.shape)
      if (axes == 1):
         dump_array(m, name)
      elif (axes == 2):
         dump_matrix(m, name)

####################################################""
      
centers_n = np.array([[ 0.031856, 0.0319444],
                 [ 0.098338, 0.0319444],
                 [ 0.166205, 0.0333333],
                 [ 0.236842, 0.0305556],
                 [ 0.307479, 0.0291667],
                 [ 0.386427, 0.0277778],
                 [ 0.504155, 0.0111111],
                 [ 0.614958, 0.0291667],
                 [ 0.685596, 0.0333333],
                 [ 0.757618, 0.0305556],
                 [ 0.828255, 0.0333333],
                 [ 0.897507, 0.0333333],
                 [ 0.965374, 0.0305556],
                 [ 0.031856, 0.0986111],
                 [ 0.0969529, 0.0986111],
                 [ 0.16205, 0.102778],
                 [ 0.224377, 0.0958333],
                 [ 0.286704, 0.101389],
                 [ 0.34349, 0.0833333],
                 [ 0.645429, 0.109722],
                 [ 0.710526, 0.0972222],
                 [ 0.774238, 0.0972222],
                 [ 0.83518, 0.106944],
                 [ 0.898892, 0.102778],
                 [ 0.965374, 0.0930556],
                 [ 0.031856, 0.165278],
                 [ 0.0969529, 0.163889],
                 [ 0.16205, 0.173611],
                 [ 0.222992, 0.161111],
                 [ 0.285319, 0.169444],
                 [ 0.34349, 0.170833],
                 [ 0.685596, 0.165278],
                 [ 0.756233, 0.1625],
                 [ 0.828255, 0.179167],
                 [ 0.894737, 0.175],
                 [ 0.963989, 0.155556],
                 [ 0.033241, 0.233333],
                 [ 0.101108, 0.230556],
                 [ 0.17036, 0.244444],
                 [ 0.240997, 0.226389],
                 [ 0.319945, 0.2375],
                 [ 0.700831, 0.233333],
                 [ 0.768698, 0.227778],
                 [ 0.833795, 0.256944],
                 [ 0.896122, 0.248611],
                 [ 0.961219, 0.215278],
                 [ 0.0304709, 0.301389],
                 [ 0.101108, 0.298611],
                 [ 0.16759, 0.313889],
                 [ 0.245152, 0.291667],
                 [ 0.313019, 0.304167],
                 [ 0.390582, 0.277778],
                 [ 0.555402, 0.313889],
                 [ 0.688366, 0.298611],
                 [ 0.770083, 0.297222],
                 [ 0.966759, 0.273611],
                 [ 0.0484765, 0.365278],
                 [ 0.296399, 0.370833],
                 [ 0.365651, 0.352778],
                 [ 0.430748, 0.347222],
                 [ 0.495845, 0.375],
                 [ 0.567867, 0.375],
                 [ 0.627424, 0.341667],
                 [ 0.682825, 0.370833],
                 [ 0.739612, 0.356944],
                 [ 0.289474, 0.444444],
                 [ 0.358726, 0.420833],
                 [ 0.426593, 0.425],
                 [ 0.49446, 0.441667],
                 [ 0.562327, 0.434722],
                 [ 0.627424, 0.420833],
                 [ 0.691136, 0.433333],
                 [ 0.752078, 0.445833],
                 [ 0.358726, 0.4875],
                 [ 0.427978, 0.505556],
                 [ 0.49446, 0.504167],
                 [ 0.559557, 0.491667],
                 [ 0.627424, 0.493056],
                 [ 0.689751, 0.498611],
                 [ 0.753463, 0.5125],
                 [ 0.963989, 0.506944],
                 [ 0.0166205, 0.541667],
                 [ 0.295014, 0.586111],
                 [ 0.365651, 0.555556],
                 [ 0.434903, 0.584722],
                 [ 0.498615, 0.568056],
                 [ 0.567867, 0.548611],
                 [ 0.632964, 0.568056],
                 [ 0.699446, 0.565278],
                 [ 0.767313, 0.575],
                 [ 0.831025, 0.558333],
                 [ 0.897507, 0.555556],
                 [ 0.963989, 0.572222],
                 [ 0.0304709, 0.630556],
                 [ 0.098338, 0.616667],
                 [ 0.163435, 0.627778],
                 [ 0.227147, 0.618056],
                 [ 0.295014, 0.644444],
                 [ 0.369806, 0.622222],
                 [ 0.555402, 0.604167],
                 [ 0.627424, 0.6375],
                 [ 0.698061, 0.631944],
                 [ 0.765928, 0.6375],
                 [ 0.83241, 0.627778],
                 [ 0.897507, 0.627778],
                 [ 0.965374, 0.636111],
                 [ 0.033241, 0.698611],
                 [ 0.099723, 0.6875],
                 [ 0.168975, 0.697222],
                 [ 0.239612, 0.691667],
                 [ 0.317175, 0.698611],
                 [ 0.606648, 0.701389],
                 [ 0.68144, 0.697222],
                 [ 0.754848, 0.7],
                 [ 0.82687, 0.695833],
                 [ 0.897507, 0.702778],
                 [ 0.965374, 0.698611],
                 [ 0.031856, 0.765278],
                 [ 0.098338, 0.759722],
                 [ 0.163435, 0.765278],
                 [ 0.228532, 0.761111],
                 [ 0.293629, 0.763889],
                 [ 0.361496, 0.754167],
                 [ 0.641274, 0.765278],
                 [ 0.706371, 0.763889],
                 [ 0.770083, 0.766667],
                 [ 0.83518, 0.761111],
                 [ 0.898892, 0.780556],
                 [ 0.963989, 0.7625],
                 [ 0.031856, 0.831944],
                 [ 0.098338, 0.830556],
                 [ 0.16482, 0.831944],
                 [ 0.231302, 0.830556],
                 [ 0.296399, 0.831944],
                 [ 0.360111, 0.829167],
                 [ 0.433518, 0.840278],
                 [ 0.50554, 0.831944],
                 [ 0.573407, 0.818056],
                 [ 0.632964, 0.836111],
                 [ 0.698061, 0.830556],
                 [ 0.764543, 0.833333],
                 [ 0.83241, 0.829167],
                 [ 0.894737, 0.858333],
                 [ 0.963989, 0.827778],
                 [ 0.031856, 0.898611],
                 [ 0.098338, 0.898611],
                 [ 0.16482, 0.898611],
                 [ 0.231302, 0.898611],
                 [ 0.297784, 0.898611],
                 [ 0.364266, 0.895833],
                 [ 0.429363, 0.905556],
                 [ 0.49723, 0.898611],
                 [ 0.563712, 0.890278],
                 [ 0.628809, 0.901389],
                 [ 0.695291, 0.898611],
                 [ 0.763158, 0.9],
                 [ 0.831025, 0.898611],
                 [ 0.955679, 0.891667],
                 [ 0.031856, 0.965278],
                 [ 0.098338, 0.965278],
                 [ 0.16482, 0.965278],
                 [ 0.231302, 0.965278],
                 [ 0.297784, 0.965278],
                 [ 0.364266, 0.963889],
                 [ 0.430748, 0.968056],
                 [ 0.498615, 0.965278],
                 [ 0.566482, 0.9625],
                 [ 0.638504, 0.966667],
                 [ 0.711911, 0.965278],
                 [ 0.785319, 0.965278],
                 [ 0.860111, 0.975]],
                dtype=np.float64)

circle = np.array([[ 0.649861, 0.5],
                   [ 0.649845, 0.502211],
                   [ 0.649797, 0.504422],
                   [ 0.649716, 0.506632],
                   [ 0.649602, 0.50884],
                   [ 0.649456, 0.511047],
                   [ 0.649278, 0.513251],
                   [ 0.649067, 0.515452],
                   [ 0.648824, 0.51765],
                   [ 0.648549, 0.519844],
                   [ 0.648242, 0.522033],
                   [ 0.647903, 0.524218],
                   [ 0.647531, 0.526398],
                   [ 0.647128, 0.528572],
                   [ 0.646693, 0.53074],
                   [ 0.646226, 0.532901],
                   [ 0.645727, 0.535055],
                   [ 0.645197, 0.537201],
                   [ 0.644636, 0.53934],
                   [ 0.644043, 0.541469],
                   [ 0.643419, 0.54359],
                   [ 0.642763, 0.545702],
                   [ 0.642077, 0.547803],
                   [ 0.64136, 0.549894],
                   [ 0.640613, 0.551975],
                   [ 0.639835, 0.554044],
                   [ 0.639027, 0.556101],
                   [ 0.638189, 0.558147],
                   [ 0.637321, 0.560179],
                   [ 0.636423, 0.562199],
                   [ 0.635495, 0.564205],
                   [ 0.634538, 0.566197],
                   [ 0.633553, 0.568175],
                   [ 0.632538, 0.570139],
                   [ 0.631494, 0.572087],
                   [ 0.630422, 0.574019],
                   [ 0.629322, 0.575935],
                   [ 0.628194, 0.577835],
                   [ 0.627038, 0.579718],
                   [ 0.625854, 0.581584],
                   [ 0.624644, 0.583432],
                   [ 0.623406, 0.585262],
                   [ 0.622141, 0.587074],
                   [ 0.62085, 0.588867],
                   [ 0.619533, 0.59064],
                   [ 0.61819, 0.592394],
                   [ 0.616822, 0.594128],
                   [ 0.615428, 0.595842],
                   [ 0.614009, 0.597535],
                   [ 0.612566, 0.599206],
                   [ 0.611098, 0.600856],
                   [ 0.609606, 0.602485],
                   [ 0.60809, 0.604091],
                   [ 0.606551, 0.605674],
                   [ 0.604989, 0.607235],
                   [ 0.603404, 0.608773],
                   [ 0.601797, 0.610287],
                   [ 0.600168, 0.611777],
                   [ 0.598517, 0.613243],
                   [ 0.596844, 0.614684],
                   [ 0.595151, 0.616101],
                   [ 0.593437, 0.617492],
                   [ 0.591703, 0.618858],
                   [ 0.589949, 0.620198],
                   [ 0.588176, 0.621512],
                   [ 0.586383, 0.6228],
                   [ 0.584572, 0.624061],
                   [ 0.582742, 0.625296],
                   [ 0.580895, 0.626503],
                   [ 0.57903, 0.627683],
                   [ 0.577148, 0.628835],
                   [ 0.575249, 0.62996],
                   [ 0.573334, 0.631056],
                   [ 0.571403, 0.632124],
                   [ 0.569456, 0.633163],
                   [ 0.567495, 0.634173],
                   [ 0.565519, 0.635155],
                   [ 0.563528, 0.636107],
                   [ 0.561524, 0.63703],
                   [ 0.559507, 0.637923],
                   [ 0.557477, 0.638786],
                   [ 0.555434, 0.639619],
                   [ 0.553379, 0.640421],
                   [ 0.551313, 0.641194],
                   [ 0.549236, 0.641936],
                   [ 0.547148, 0.642647],
                   [ 0.54505, 0.643327],
                   [ 0.542942, 0.643976],
                   [ 0.540824, 0.644594],
                   [ 0.538698, 0.645181],
                   [ 0.536564, 0.645736],
                   [ 0.534421, 0.64626],
                   [ 0.532271, 0.646752],
                   [ 0.530115, 0.647212],
                   [ 0.527951, 0.647641],
                   [ 0.525782, 0.648037],
                   [ 0.523607, 0.648402],
                   [ 0.521427, 0.648734],
                   [ 0.519242, 0.649034],
                   [ 0.517053, 0.649302],
                   [ 0.51486, 0.649537],
                   [ 0.512665, 0.64974],
                   [ 0.510466, 0.649911],
                   [ 0.508265, 0.650049],
                   [ 0.506063, 0.650155],
                   [ 0.503859, 0.650228],
                   [ 0.501654, 0.650269],
                   [ 0.499449, 0.650277],
                   [ 0.497244, 0.650252],
                   [ 0.495039, 0.650195],
                   [ 0.492836, 0.650106],
                   [ 0.490634, 0.649984],
                   [ 0.488434, 0.64983],
                   [ 0.486237, 0.649643],
                   [ 0.484043, 0.649423],
                   [ 0.481852, 0.649172],
                   [ 0.479665, 0.648888],
                   [ 0.477483, 0.648572],
                   [ 0.475305, 0.648223],
                   [ 0.473133, 0.647843],
                   [ 0.470966, 0.647431],
                   [ 0.468806, 0.646986],
                   [ 0.466653, 0.64651],
                   [ 0.464506, 0.646002],
                   [ 0.462368, 0.645463],
                   [ 0.460238, 0.644892],
                   [ 0.458116, 0.644289],
                   [ 0.456003, 0.643656],
                   [ 0.4539, 0.642991],
                   [ 0.451807, 0.642295],
                   [ 0.449724, 0.641569],
                   [ 0.447652, 0.640812],
                   [ 0.445592, 0.640024],
                   [ 0.443543, 0.639206],
                   [ 0.441506, 0.638358],
                   [ 0.439483, 0.63748],
                   [ 0.437472, 0.636572],
                   [ 0.435475, 0.635635],
                   [ 0.433491, 0.634668],
                   [ 0.431523, 0.633672],
                   [ 0.429569, 0.632647],
                   [ 0.42763, 0.631593],
                   [ 0.425707, 0.630511],
                   [ 0.4238, 0.629401],
                   [ 0.421909, 0.628263],
                   [ 0.420036, 0.627097],
                   [ 0.418179, 0.625903],
                   [ 0.416341, 0.624682],
                   [ 0.41452, 0.623434],
                   [ 0.412718, 0.62216],
                   [ 0.410935, 0.620858],
                   [ 0.409172, 0.619531],
                   [ 0.407427, 0.618178],
                   [ 0.405703, 0.616799],
                   [ 0.404, 0.615395],
                   [ 0.402317, 0.613966],
                   [ 0.400655, 0.612513],
                   [ 0.399015, 0.611035],
                   [ 0.397397, 0.609533],
                   [ 0.395801, 0.608007],
                   [ 0.394227, 0.606458],
                   [ 0.392676, 0.604885],
                   [ 0.391149, 0.603291],
                   [ 0.389645, 0.601673],
                   [ 0.388165, 0.600034],
                   [ 0.386709, 0.598373],
                   [ 0.385278, 0.596691],
                   [ 0.383872, 0.594988],
                   [ 0.382491, 0.593264],
                   [ 0.381135, 0.59152],
                   [ 0.379805, 0.589756],
                   [ 0.378501, 0.587973],
                   [ 0.377223, 0.586171],
                   [ 0.375972, 0.58435],
                   [ 0.374748, 0.582511],
                   [ 0.373551, 0.580654],
                   [ 0.372381, 0.578779],
                   [ 0.371239, 0.576887],
                   [ 0.370124, 0.574979],
                   [ 0.369038, 0.573055],
                   [ 0.36798, 0.571115],
                   [ 0.366951, 0.569159],
                   [ 0.365951, 0.567188],
                   [ 0.364979, 0.565203],
                   [ 0.364037, 0.563204],
                   [ 0.363125, 0.561191],
                   [ 0.362242, 0.559165],
                   [ 0.361388, 0.557126],
                   [ 0.360565, 0.555074],
                   [ 0.359772, 0.553011],
                   [ 0.359009, 0.550936],
                   [ 0.358277, 0.54885],
                   [ 0.357576, 0.546754],
                   [ 0.356905, 0.544647],
                   [ 0.356266, 0.542531],
                   [ 0.355657, 0.540406],
                   [ 0.35508, 0.538271],
                   [ 0.354534, 0.536129],
                   [ 0.35402, 0.533979],
                   [ 0.353537, 0.531821],
                   [ 0.353086, 0.529657],
                   [ 0.352666, 0.527486],
                   [ 0.352279, 0.525309],
                   [ 0.351924, 0.523126],
                   [ 0.3516, 0.520939],
                   [ 0.351309, 0.518747],
                   [ 0.35105, 0.516551],
                   [ 0.350823, 0.514352],
                   [ 0.350629, 0.512149],
                   [ 0.350467, 0.509944],
                   [ 0.350337, 0.507736],
                   [ 0.35024, 0.505527],
                   [ 0.350175, 0.503317],
                   [ 0.350143, 0.501106],
                   [ 0.350143, 0.498894],
                   [ 0.350175, 0.496683],
                   [ 0.35024, 0.494473],
                   [ 0.350337, 0.492264],
                   [ 0.350467, 0.490056],
                   [ 0.350629, 0.487851],
                   [ 0.350823, 0.485648],
                   [ 0.35105, 0.483449],
                   [ 0.351309, 0.481253],
                   [ 0.3516, 0.479061],
                   [ 0.351924, 0.476874],
                   [ 0.352279, 0.474691],
                   [ 0.352666, 0.472514],
                   [ 0.353086, 0.470343],
                   [ 0.353537, 0.468179],
                   [ 0.35402, 0.466021],
                   [ 0.354534, 0.463871],
                   [ 0.35508, 0.461729],
                   [ 0.355657, 0.459594],
                   [ 0.356266, 0.457469],
                   [ 0.356905, 0.455353],
                   [ 0.357576, 0.453246],
                   [ 0.358277, 0.45115],
                   [ 0.359009, 0.449064],
                   [ 0.359772, 0.446989],
                   [ 0.360565, 0.444926],
                   [ 0.361388, 0.442874],
                   [ 0.362242, 0.440835],
                   [ 0.363125, 0.438809],
                   [ 0.364037, 0.436796],
                   [ 0.364979, 0.434797],
                   [ 0.365951, 0.432812],
                   [ 0.366951, 0.430841],
                   [ 0.36798, 0.428885],
                   [ 0.369038, 0.426945],
                   [ 0.370124, 0.425021],
                   [ 0.371239, 0.423113],
                   [ 0.372381, 0.421221],
                   [ 0.373551, 0.419346],
                   [ 0.374748, 0.417489],
                   [ 0.375972, 0.41565],
                   [ 0.377223, 0.413829],
                   [ 0.378501, 0.412027],
                   [ 0.379805, 0.410244],
                   [ 0.381135, 0.40848],
                   [ 0.382491, 0.406736],
                   [ 0.383872, 0.405012],
                   [ 0.385278, 0.403309],
                   [ 0.386709, 0.401627],
                   [ 0.388165, 0.399966],
                   [ 0.389645, 0.398327],
                   [ 0.391149, 0.396709],
                   [ 0.392676, 0.395115],
                   [ 0.394227, 0.393542],
                   [ 0.395801, 0.391993],
                   [ 0.397397, 0.390467],
                   [ 0.399015, 0.388965],
                   [ 0.400655, 0.387487],
                   [ 0.402317, 0.386034],
                   [ 0.404, 0.384605],
                   [ 0.405703, 0.383201],
                   [ 0.407427, 0.381822],
                   [ 0.409172, 0.380469],
                   [ 0.410935, 0.379142],
                   [ 0.412718, 0.37784],
                   [ 0.41452, 0.376566],
                   [ 0.416341, 0.375318],
                   [ 0.418179, 0.374097],
                   [ 0.420036, 0.372903],
                   [ 0.421909, 0.371737],
                   [ 0.4238, 0.370599],
                   [ 0.425707, 0.369489],
                   [ 0.42763, 0.368407],
                   [ 0.429569, 0.367353],
                   [ 0.431523, 0.366328],
                   [ 0.433491, 0.365332],
                   [ 0.435475, 0.364365],
                   [ 0.437472, 0.363428],
                   [ 0.439483, 0.36252],
                   [ 0.441506, 0.361642],
                   [ 0.443543, 0.360794],
                   [ 0.445592, 0.359976],
                   [ 0.447652, 0.359188],
                   [ 0.449724, 0.358431],
                   [ 0.451807, 0.357705],
                   [ 0.4539, 0.357009],
                   [ 0.456003, 0.356344],
                   [ 0.458116, 0.355711],
                   [ 0.460238, 0.355108],
                   [ 0.462368, 0.354537],
                   [ 0.464506, 0.353998],
                   [ 0.466653, 0.35349],
                   [ 0.468806, 0.353014],
                   [ 0.470966, 0.352569],
                   [ 0.473133, 0.352157],
                   [ 0.475305, 0.351777],
                   [ 0.477483, 0.351428],
                   [ 0.479665, 0.351112],
                   [ 0.481852, 0.350828],
                   [ 0.484043, 0.350577],
                   [ 0.486237, 0.350357],
                   [ 0.488434, 0.35017],
                   [ 0.490634, 0.350016],
                   [ 0.492836, 0.349894],
                   [ 0.495039, 0.349805],
                   [ 0.497244, 0.349748],
                   [ 0.499449, 0.349723],
                   [ 0.501654, 0.349731],
                   [ 0.503859, 0.349772],
                   [ 0.506063, 0.349845],
                   [ 0.508265, 0.349951],
                   [ 0.510466, 0.350089],
                   [ 0.512665, 0.35026],
                   [ 0.51486, 0.350463],
                   [ 0.517053, 0.350698],
                   [ 0.519242, 0.350966],
                   [ 0.521427, 0.351266],
                   [ 0.523607, 0.351598],
                   [ 0.525782, 0.351963],
                   [ 0.527951, 0.352359],
                   [ 0.530115, 0.352788],
                   [ 0.532271, 0.353248],
                   [ 0.534421, 0.35374],
                   [ 0.536564, 0.354264],
                   [ 0.538698, 0.354819],
                   [ 0.540824, 0.355406],
                   [ 0.542942, 0.356024],
                   [ 0.54505, 0.356673],
                   [ 0.547148, 0.357353],
                   [ 0.549236, 0.358064],
                   [ 0.551313, 0.358806],
                   [ 0.553379, 0.359579],
                   [ 0.555434, 0.360381],
                   [ 0.557477, 0.361214],
                   [ 0.559507, 0.362077],
                   [ 0.561524, 0.36297],
                   [ 0.563528, 0.363893],
                   [ 0.565519, 0.364845],
                   [ 0.567495, 0.365827],
                   [ 0.569456, 0.366837],
                   [ 0.571403, 0.367876],
                   [ 0.573334, 0.368944],
                   [ 0.575249, 0.37004],
                   [ 0.577148, 0.371165],
                   [ 0.57903, 0.372317],
                   [ 0.580895, 0.373497],
                   [ 0.582742, 0.374704],
                   [ 0.584572, 0.375939],
                   [ 0.586383, 0.3772],
                   [ 0.588176, 0.378488],
                   [ 0.589949, 0.379802],
                   [ 0.591703, 0.381142],
                   [ 0.593437, 0.382508],
                   [ 0.595151, 0.383899],
                   [ 0.596844, 0.385316],
                   [ 0.598517, 0.386757],
                   [ 0.600168, 0.388223],
                   [ 0.601797, 0.389713],
                   [ 0.603404, 0.391227],
                   [ 0.604989, 0.392765],
                   [ 0.606551, 0.394326],
                   [ 0.60809, 0.395909],
                   [ 0.609606, 0.397515],
                   [ 0.611098, 0.399144],
                   [ 0.612566, 0.400794],
                   [ 0.614009, 0.402465],
                   [ 0.615428, 0.404158],
                   [ 0.616822, 0.405872],
                   [ 0.61819, 0.407606],
                   [ 0.619533, 0.40936],
                   [ 0.62085, 0.411133],
                   [ 0.622141, 0.412926],
                   [ 0.623406, 0.414738],
                   [ 0.624644, 0.416568],
                   [ 0.625854, 0.418416],
                   [ 0.627038, 0.420282],
                   [ 0.628194, 0.422165],
                   [ 0.629322, 0.424065],
                   [ 0.630422, 0.425981],
                   [ 0.631494, 0.427913],
                   [ 0.632538, 0.429861],
                   [ 0.633553, 0.431825],
                   [ 0.634538, 0.433803],
                   [ 0.635495, 0.435795],
                   [ 0.636423, 0.437801],
                   [ 0.637321, 0.439821],
                   [ 0.638189, 0.441853],
                   [ 0.639027, 0.443899],
                   [ 0.639835, 0.445956],
                   [ 0.640613, 0.448025],
                   [ 0.64136, 0.450106],
                   [ 0.642077, 0.452197],
                   [ 0.642763, 0.454298],
                   [ 0.643419, 0.45641],
                   [ 0.644043, 0.458531],
                   [ 0.644636, 0.46066],
                   [ 0.645197, 0.462799],
                   [ 0.645727, 0.464945],
                   [ 0.646226, 0.467099],
                   [ 0.646693, 0.46926],
                   [ 0.647128, 0.471428],
                   [ 0.647531, 0.473602],
                   [ 0.647903, 0.475782],
                   [ 0.648242, 0.477967],
                   [ 0.648549, 0.480156],
                   [ 0.648824, 0.48235],
                   [ 0.649067, 0.484548],
                   [ 0.649278, 0.486749],
                   [ 0.649456, 0.488953],
                   [ 0.649602, 0.49116],
                   [ 0.649716, 0.493368],
                   [ 0.649797, 0.495578],
                   [ 0.649845, 0.497789]],
                dtype=np.float64)



def iterate_enet(centers, ps, k, t, period=25, ka=0.99, alpha=0.2, beta=2.0):
   deltas = centers[:,np.newaxis] - ps
   
   ds2 = np.sum(deltas**2, axis=2)
   
   dump(1, ds2, 'ds2_p')
   dump_scalar(1, k, 'k_p')
      
   ws = np.exp(-ds2 / (2 * (k**2)))
   dump(1, ws, 'ws_p')

   S = np.zeros(ws.shape[0], np.float64)
   for city in range(ws.shape[0]):
      for node in range(ws.shape[1]):
         S[city] += ws[city][node]
   
   ws /= S[:,np.newaxis]
   #ws /= ws.sum(axis=1)[:,np.newaxis]
   dump(1, ws, 'ws/sum_p')
   
   if (t % period == 0):
      k = max(0.01, ka*k)   
      
   dforce = np.array([np.dot(ws[:,i], deltas[:,i]) for i in range(len(ps))])
   dump(1, dforce, 'dforce_p')
   
   tension = np.concatenate([[ps[1] - 2 * ps[0] + ps[Kp - 1]],
                             [(ps[i-1] - 2 * ps[i] + ps[i+1]) for i in range(1, Kp-1)],
                             [ps[0] - 2 * ps[Kp - 1] + ps[Kp - 2]]])
#   tension = np.concatenate([[ps[1] - 2 * ps[0] + ps[Kp - 1]],
#                             np.diff(ps, n=2, axis=0),
#                             [ps[0] - 2 * ps[Kp - 1] + ps[Kp - 2]]])


   dump(1, tension, 'tension_p')

   dump_scalar(1, alpha, 'alpha_p')
   dump_scalar(1, beta, 'beta_p')
   dump_scalar(1, k, 'k_p')
   
   ps += alpha * dforce + beta * k * tension
   
   dmax = np.sqrt(np.max(np.min(ds2, axis=1)))
   dump_scalar(1, dmax, 'dmax_p')
   
   return ps, k, dmax   




N = 10000
Kc = len(centers_n)
Kp = int(2.5*Kc)
k0 = 0.2
eps = 0.01

paths = np.zeros([N,Kp,2], dtype=np.float64)
dms = np.zeros(N, dtype=np.float64)
ks = np.zeros(N, dtype=np.float64)
ks[0] = k0
R_init = 0.1

paths[0] = circle

dump(0, centers_n, 'cities')
dump(0, circle, 'path')

   
for t in range(1, N):
   #print(t)
   
   paths[t], ks[t], dms[t-1] = iterate_enet(centers_n,
                                            paths[t-1].copy(),
                                            ks[t-1],
                                            t)
   dump(0, paths[t], "path")
   
   if dms[t-1] < eps:
      break

#idx = np.where(dms>0)[0][-1]


#idx=-1
#print(len(paths[idx]))
#for i in range(len(paths[idx])):
#   print(paths[idx,i,0],paths[idx,i,1])
   #print(circle[i,0],circle[i,1])

